
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼é¢¨ã‚¹ãƒ­ãƒƒãƒˆï¼ˆè¤‡æ•°æ®µï¼‹æ–œã‚åˆ¤å®šï¼‰</title>
<style>
  body {
    font-family: sans-serif;
    background:#222; color:#fff;
    text-align:center;
    margin:0; padding:20px;
  }
  .slot {
    display:flex;
    justify-content:center;
    gap:10px;
    margin:15px 0;
  }
  .reel {
    width: 60px;
    height: 120px;
    overflow: hidden;
    border: 2px solid #555;
    background: black;
    position: relative;
  }
  .symbols {
    position: absolute;
    top: 0;
    transition: top 0.3s ease-out;
  }
  .symbol {
    height: 40px;
    font-size: 32px;
    line-height: 40px;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    margin: 5px;
  }
  #gogo {
    display: none;
    font-size: 48px;
    color: magenta;
    font-weight: bold;
    animation: blink 1s infinite, grow 1s infinite alternate;
  }
  @keyframes blink {
    0%, 100% {opacity:1;}
    50% {opacity:0.2;}
  }
  @keyframes grow {
    0% {transform: scale(1);}
    100% {transform: scale(1.2);}
  }
  input[type="number"] {
    width: 80px;
    font-size: 16px;
    text-align: right;
    margin-left: 5px;
  }
  #loan-area {
    margin-top: 10px;
    color: #f55;
  }
  @media (max-width: 600px) {
    .reel { width: 50px; height: 100px;}
    .symbol { font-size: 28px; height: 33px; line-height: 33px;}
    button { font-size: 14px;}
  }
</style>
</head>
<body>

<h1>ğŸ° ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼é¢¨ã‚¹ãƒ­ãƒƒãƒˆï¼ˆè¤‡æ•°æ®µï¼‹æ–œã‚æƒã„å¯¾å¿œï¼‰</h1>

<div>
  æ‰€æŒã‚³ã‚¤ãƒ³: <span id="coin-count">0</span> æšã€€
  ãƒ™ãƒƒãƒˆ: <input type="number" id="bet-amount" value="3" min="1" />
</div>

<div class="slot" id="slot">
  <div class="reel" id="reel0"><div class="symbols"></div></div>
  <div class="reel" id="reel1"><div class="symbols"></div></div>
  <div class="reel" id="reel2"><div class="symbols"></div></div>
</div>

<div id="gogo">GOGO!!</div>

<div>
  <button onclick="start()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button onclick="stop(0)">ã‚¹ãƒˆãƒƒãƒ—â‘ </button>
  <button onclick="stop(1)">ã‚¹ãƒˆãƒƒãƒ—â‘¡</button>
  <button onclick="stop(2)">ã‚¹ãƒˆãƒƒãƒ—â‘¢</button>
</div>

<div>
  <button onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤</button>
  <button onclick="toggleSlowSpin()">ç›®æŠ¼ã—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
</div>

<div id="loan-area" style="display:none;">
  ã‚³ã‚¤ãƒ³ãŒãªããªã‚Šã¾ã—ãŸã€‚<button onclick="loanCoins()">è²¸ã—å‡ºã—ã™ã‚‹</button>
</div>

<script>
const symbols = ["ğŸ’", "ğŸ‡", "ğŸ””", "7ï¸âƒ£", "BAR", "ğŸŒˆ"];
const symbolProb = {
  "ğŸ’": 0.3, "ğŸ‡": 0.25, "ğŸ””": 0.2,
  "7ï¸âƒ£": 0.15, "BAR": 0.09, "ğŸŒˆ": 0.01
};

const reels = [
  document.querySelector("#reel0 .symbols"),
  document.querySelector("#reel1 .symbols"),
  document.querySelector("#reel2 .symbols")
];
const reelContainers = [
  document.getElementById("reel0"),
  document.getElementById("reel1"),
  document.getElementById("reel2")
];
const gogoEl = document.getElementById("gogo");
const coinCountEl = document.getElementById("coin-count");
const betInput = document.getElementById("bet-amount");

const bgmBig = new Audio("https://assets.mixkit.co/music/preview/mixkit-game-level-completed-2059.mp3");
const bgmReg = new Audio("https://assets.mixkit.co/music/preview/mixkit-retro-arcade-funk-213.mp3");
bgmBig.loop = true; bgmReg.loop = true;

let coins = 100;
let spinning = [false, false, false];
let stopped = [false, false, false];
let spinIntervals = [null, null, null];
let spinPositions = [null, null, null]; // ã“ã“ã¯å„ãƒªãƒ¼ãƒ«ã®åœæ­¢ã‚·ãƒ³ãƒœãƒ«é…åˆ—3ã¤å…¥ã‚‹
let currentStopIndex = 0;
let autoPlay = false;
let lastBet = 3;
const symbolHeight = 40;
let isSlowSpin = false;

function updateCoinDisplay() {
  coinCountEl.textContent = coins;
  const loanArea = document.getElementById("loan-area");
  if (coins <= 0) {
    loanArea.style.display = "block";
  } else {
    loanArea.style.display = "none";
  }
}

function loadCoins() {
  const saved = localStorage.getItem("juggler_coins");
  if (saved !== null) coins = parseInt(saved, 10);
  updateCoinDisplay();
}

function saveCoins() {
  localStorage.setItem("juggler_coins", coins);
}

function getRandomSymbol() {
  const rand = Math.random();
  let sum = 0;
  for (const s of symbols) {
    sum += symbolProb[s];
    if (rand < sum) return s;
  }
  return "ğŸ’";
}

// è¤‡æ•°æ®µãƒªãƒ¼ãƒ«ç”¨ã®ç¸¦3ã¤åˆ†ã®ã‚·ãƒ³ãƒœãƒ«ç”Ÿæˆ
function generateReelSymbols() {
  for (let i = 0; i < 3; i++) {
    const container = reels[i];
    container.innerHTML = "";
    // ã‚·ãƒ³ãƒœãƒ«ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«3å€‹ï¼ˆä¸Š ä¸­ ä¸‹ï¼‰
    for (let y = 0; y < 3; y++) {
      const div = document.createElement("div");
      div.className = "symbol";
      div.textContent = getRandomSymbol();
      container.appendChild(div);
    }
    container.style.top = "0px";
  }
}

// ã‚¹ãƒ”ãƒ³ã‚¢ãƒ‹ãƒ¡ï¼ˆé«˜é€Ÿå›è»¢ï¼‰
function spinReel(index) {
  spinning[index] = true;
  let pos = 0;
  const container = reels[index];
  const speed = isSlowSpin ? 150 : 50; // ç›®æŠ¼ã—æ™‚ã¯é…ãå›è»¢
  spinIntervals[index] = setInterval(() => {
    pos = (pos + 1) % 3; // 3æ®µãªã®ã§3ãƒ«ãƒ¼ãƒ—
    container.style.top = `-${pos * symbolHeight}px`;
  }, speed);
}

// åœæ­¢å‡¦ç†
function stop(index) {
  if (!spinning[index] || stopped[index]) return;
  if (index !== currentStopIndex) return; // å·¦â†’å³é †ç•ªå³å®ˆ

  clearInterval(spinIntervals[index]);
  spinning[index] = false;
  stopped[index] = true;
  currentStopIndex++;

  let currentTop = parseInt(reels[index].style.top || "0", 10);
  if (isNaN(currentTop)) currentTop = 0;

  // 3æ®µã®ã©ã®ä½ç½®ã§æ­¢ã¾ã£ãŸã‹è¨ˆç®—
  const snapIndex = Math.round(Math.abs(currentTop) / symbolHeight) % 3;

  reels[index].style.top = `-${snapIndex * symbolHeight}px`;

  // æ­¢ã¾ã£ãŸ3æ®µåˆ†ã®ã‚·ãƒ³ãƒœãƒ«ã‚’é…åˆ—ã¨ã—ã¦å–å¾—ï¼ˆä¸Š ä¸­ ä¸‹ï¼‰
  const symbolElems = reels[index].children;
  let stoppedSymbols = [];
  for(let i=0; i<3; i++){
    stoppedSymbols.push(symbolElems[(snapIndex + i) % 3].textContent);
  }
  spinPositions[index] = stoppedSymbols;

  if (stopped.every(v => v)) {
    checkResult();
  }
}

// æ‰•ã„å‡ºã—åˆ¤å®šï¼ˆæ¨ª3åˆ—ã€æ–œã‚2åˆ—ï¼‰
function checkResult() {
  // æ¨ªãƒ©ã‚¤ãƒ³ï¼ˆä¸­æ®µã®ã¿ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼ã¯ä¸­æ®µåˆ¤å®šï¼‰
  const line = spinPositions.map(col => col[1]);

  // æ¨ªæƒã„åˆ¤å®š
  if (line.every(s => s === "7ï¸âƒ£")) {
    bigBonus();
    return;
  }
  if (line.every(s => s === "BAR")) {
    regBonus();
    return;
  }

  // æ–œã‚æƒã„åˆ¤å®š
  // å·¦ä¸Šâ†’ä¸­å¤®â†’å³ä¸‹
  if (
    spinPositions[0][0] === "7ï¸âƒ£" &&
    spinPositions[1][1] === "7ï¸âƒ£" &&
    spinPositions[2][2] === "7ï¸âƒ£"
  ) {
    bigBonus();
    return;
  }
  if (
    spinPositions[0][2] === "7ï¸âƒ£" &&
    spinPositions[1][1] === "7ï¸âƒ£" &&
    spinPositions[2][0] === "7ï¸âƒ£"
  ) {
    bigBonus();
    return;
  }
  if (
    spinPositions[0][0] === "BAR" &&
    spinPositions[1][1] === "BAR" &&
    spinPositions[2][2] === "BAR"
  ) {
    regBonus();
    return;
  }
  if (
    spinPositions[0][2] === "BAR" &&
    spinPositions[1][1] === "BAR" &&
    spinPositions[2][0] === "BAR"
  ) {
    regBonus();
    return;
  }

  alert("ã¯ãšã‚Œ");
  if (autoPlay) setTimeout(start, 1000);
}

// BIGãƒœãƒ¼ãƒŠã‚¹æ¼”å‡º
async function bigBonus() {
  gogoEl.style.display = "block";
  reelContainers.forEach(rc => rc.style.borderColor = "magenta");
  bgmBig.currentTime = 0;
  bgmBig.play();

  let bigCoins = 0;
  const bigMax = 100;
  for (let i = 0; i <= bigMax; i += 5) {
    bigCoins = i;
    coins += 5;
    updateCoinDisplay();
    await new Promise(r => setTimeout(r, 100));
  }
  saveCoins();
  bgmBig.pause();
  reelContainers.forEach(rc => rc.style.borderColor = "#555");
  gogoEl.style.display = "none";

  if (autoPlay) setTimeout(start, 1500);
}

// REGãƒœãƒ¼ãƒŠã‚¹æ¼”å‡º
async function regBonus() {
  gogoEl.style.display = "block";
  reelContainers.forEach(rc => rc.style.borderColor = "cyan");
  bgmReg.currentTime = 0;
  bgmReg.play();

  let regCoins = 0;
  const regMax = 40;
  for (let i = 0; i <= regMax; i += 4) {
    regCoins = i;
    coins += 4;
    updateCoinDisplay();
    await new Promise(r => setTimeout(r, 150));
  }
  saveCoins();
  bgmReg.pause();
  reelContainers.forEach(rc => rc.style.borderColor = "#555");
  gogoEl.style.display = "none";

  if (autoPlay) setTimeout(start, 1500);
}

// ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†
function start() {
  lastBet = Math.min(Math.max(1, parseInt(betInput.value,10) || 3), coins);
  if(coins < lastBet){
    alert("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
    return;
  }
  coins -= lastBet;
  updateCoinDisplay();
  saveCoins();

  spinning = [false, false, false];
  stopped = [false, false, false];
  currentStopIndex = 0;
  spinPositions = [null, null, null];

  for (let i = 0; i < 3; i++) {
    generateReelSymbols(); // æ¯å›ãƒªãƒ¼ãƒ«å†…å®¹ã¯å¤‰ã‚ã‚‹ä»•æ§˜
    spinReel(i);
  }
}

// ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤åˆ‡ã‚Šæ›¿ãˆ
function toggleAuto() {
  autoPlay = !autoPlay;
  alert(`ã‚ªãƒ¼ãƒˆãƒ—ãƒ¬ã‚¤: ${autoPlay ? 'ON' : 'OFF'}`);
  if (autoPlay && !spinning.some(s => s)) {
    start();
  }
}

// ç›®æŠ¼ã—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function toggleSlowSpin() {
  isSlowSpin = !isSlowSpin;
  alert(`ç›®æŠ¼ã—ãƒ¢ãƒ¼ãƒ‰: ${isSlowSpin ? 'ON' : 'OFF'}`);
}

// è²¸ã—å‡ºã—å‡¦ç†
function loanCoins() {
  coins = 100;
  updateCoinDisplay();
  saveCoins();
  alert("ã‚³ã‚¤ãƒ³ã‚’è²¸ã—å‡ºã—ã¾ã—ãŸï¼ 100æšè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
}

loadCoins();

</script>

</body>
</html>
